name: Run n8n Workflow CLI

on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
      - cron: "0 0 * * SAT"

jobs:
  run-workflow:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm ci

      - name: Run workflow
        env:
          N8N_LOG_LEVEL: "error"
          NODE_FUNCTION_ALLOW_EXTERNAL: "mjml"
          TRANSLATION_LANGUAGE: ${{ vars.TRANSLATION_LANGUAGE || 'en-US' }}
          REPO: ${{ vars.REPO }}
          EMAIL: ${{ vars.EMAIL }}
        run: |
          ./scripts/import-workflow.sh
          WORKFLOW_ID=$(sqlite3 ~/.n8n/database.sqlite "SELECT id FROM workflow_entity ORDER BY createdAt DESC LIMIT 1;")
          npx n8n execute workflow --id $WORKFLOW_ID
