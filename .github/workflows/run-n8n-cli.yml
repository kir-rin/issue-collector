name: Run n8n Workflow CLI

on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
      - cron: "0 0 * * SAT"

jobs:
  run-workflow:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm ci

      - name: Run workflow
        env:
          N8N_LOG_LEVEL: "error"
          N8N_USER_FOLDER: "/tmp"
          NODE_FUNCTION_ALLOW_EXTERNAL: "mjml"
          TRANSLATION_LANGUAGE: ${{ vars.TRANSLATION_LANGUAGE || 'en-US' }}
          REPO: ${{ vars.REPO }}
          EMAIL: ${{ vars.EMAIL }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          N8N_GITHUB_ACCESS_TOKEN: ${{ secrets.N8N_GITHUB_ACCESS_TOKEN }}
          GOOGLE_APP_PASSWORD: ${{ secrets.GOOGLE_APP_PASSWORD }}
        run: |
          cp .env.local .env
          sh scripts/entrypoint.sh
